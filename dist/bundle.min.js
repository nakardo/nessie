window.Nes=(()=>{var t={679:(t,e,s)=>{"use strict";s.d(e,{default:()=>oe});s(593);var r=s(75),i=s.n(r),n=s(87),a=s.n(n);class o extends Error{constructor(t){super(`${t.to(16,2)} is an unknown address`),this.name=this.constructor.name,Error.captureStackTrace(this,this.constructor)}}function c(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}function h(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const l=()=>{};function u(){throw new Error("Unknown mapper")}const m=new Array(255).fill(null).map((()=>u));m[0]=class{constructor({prgRom:t,prgRam:e,chrRxm:s}){c(this,"prgRom",null),c(this,"prgRam",null),c(this,"chrRxm",null),c(this,"prgRomLastPage",0),this.prgRom=t,this.prgRam=e,this.chrRxm=s,this.prgRomLastPage=t.length-1,Object.seal(this)}w8({val:t,addr:e}){if(e<8192){const s=e>>12&1;this.chrRxm[s][4095&e]=t}else{if(e<24576)throw new o(e);if(!(e<32768))throw new o(e);this.prgRam[8191&e]=t}}r8(t){if(t<8192){const e=t>>12&1;return this.chrRxm[e][4095&t]}if(t<24576)throw new o(t);return t<32768?this.prgRam[8191&t]:t<49152?this.prgRom[0][16383&t]:this.prgRom[this.prgRomLastPage][16383&t]}},m[1]=class{constructor({prgRom:t,prgRam:e,chrRxm:s}){h(this,"prgRom",null),h(this,"prgRam",null),h(this,"chrRxm",null),h(this,"prgRomLastPage",0),h(this,"prgRamEnable",!1),h(this,"shift",0),h(this,"shiftCount",0),h(this,"mirroring",0),h(this,"prgRomBankMode",0),h(this,"chrRxmBankMode",0),h(this,"chrRxmBank",[0,0]),h(this,"prgRomBank",0),this.prgRom=t,this.prgRam=e,this.chrRxm=s,this.prgRomLastPage=t.length-1,Object.seal(this)}shiftReset(){this.shift=0,this.shiftCount=0}shiftRight(t){this.shift>>=1,this.shift|=(1&t)<<4,this.shiftCount++}getChrRxmBank(t){return 0==this.chrRxmBankMode?0==t?254&this.chrRxmBank[0]:1|this.chrRxmBank[1]:this.chrRxmBank[t]}getPrgRomBank(t){const e=this.prgRomBankMode;return 0==e||1==e?0==t?254&this.prgRomBank:1|this.prgRomBank:2==e?0==t?0:this.prgRomBank:3==e?0==t?this.prgRomBank:this.prgRomLastPage:void 0}writeRegister(t){if(l("write register: %s, val: %s",(t>>12).to(16),this.shift.to(2)),t<40960)l("set control: %s",this.shift.to(2)),this.mirroring=3&this.shift,this.prgRomBankMode=this.shift>>2&3,this.chrRxmBankMode=this.shift>>4&1;else if(t<57344){const e=t>>14&1;this.chrRxmBank[e]=31&this.shift,l("set bank chr-rxm[%d]: %d",e,this.shift)}else this.prgRamEnable=0==(16&this.shift),this.prgRomBank=15&this.shift,l("set bank prg-rom: %d",this.prgRomBank),l("prg-ram enable",this.prgRamEnable)}w8({val:t,addr:e}){if(e<8192){const s=this.getChrRxmBank(e>>12&1);this.chrRxm[s][4095&e]=t}else{if(e<24576)return;e<32768?this.prgRamEnable&&(this.prgRam[8191&e]=t):128&t?(l("reset control"),this.prgRomBankMode=3,this.shiftReset()):this.shiftCount<4?this.shiftRight(t):(this.shiftRight(t),this.writeRegister(e),this.shiftReset())}}r8(t){if(t<8192){const e=this.getChrRxmBank(t>>12&1);return this.chrRxm[e][4095&t]}if(t<24576)return 0;if(t<32768)return this.prgRam[8191&t];{const e=this.getPrgRomBank(t>>14&1);return this.prgRom[e][16383&t]}}};const p=m;function d(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const f=()=>{};class w{constructor(t){d(this,"nes",null),d(this,"prgRam",new Uint8Array(8192)),d(this,"prgRom",null),d(this,"chrRxm",null),d(this,"mapper",null),d(this,"mirroring",0),d(this,"loaded",!1),Object.seal(this),this.nes=t}static createMemory({data:t,pages:e,size:s}){return new Array(e).fill(null).map(((e,r)=>{const i=r*s,n=new Uint8Array(s);return n.set(t.slice(i,i+s)),n}))}static isInesFormat1(t){const e=2==(t[7]>>2&3);return 78===t[0]&&69===t[1]&&83===t[2]&&26===t[3]&&!e}load(t){w.isInesFormat1(t),t[6];const e=t[4],s=t[5],r=t[6]>>4|240&t[7],i=p[r];f("mapper index: %d, uses: %s",r,i.name),f("prg-rom 16kb size units: %d",e),f("chr-rxm 8kb size units: %d",s),f("mirroring: %d",1&t[6]),f("rom control byte #1: %s",t[6].to(2)),f("rom control byte #2: %s",t[7].to(2)),this.prgRom=w.createMemory({data:t.slice(16),pages:e,size:16384});let n=new Array(8192);s>0&&(n=t.slice(16+16384*e)),this.chrRxm=w.createMemory({data:n,pages:(s||1)<<1,size:4096}),this.chrRxm.forEach(((t,e)=>{t.forEach(((t,s)=>this.nes.video.updatePattern({table:e,val:t,addr:s})))})),this.mapper=new i({prgRom:this.prgRom,prgRam:this.prgRam,chrRxm:this.chrRxm}),this.mirroring=1&t[6],this.loaded=!0}r8(t){return this.loaded,this.mapper.r8(t)}w8({val:t,addr:e}){return this.loaded,this.mapper.w8({val:t,addr:e})}}const g=(t,e)=>function({branchCycles:s,cpu:r,mem:i,addr:n}){if(r[t]()==e){const t=i.r8(n);n=r.pc+((128&t)>0?-(1+(255&~t)):t),r.cycles+=r.pageCrossedCycles({branchCycles:s,addr:n}),r.pc=65535&n}},R=t=>function({cpu:e,mem:s,addr:r}){const i=e[t];let n=s.r8(r);e.carry(i>=n),n=i-n,e.sign(n),e.zero(n)},y=t=>function({cpu:e}){const s=e[t]-1;e.sign(s),e.zero(s),e[t]=255&s},A=t=>function({cpu:e}){const s=e[t]+1;e.sign(s),e.zero(s),e[t]=255&s},v=t=>function({cpu:e,mem:s,addr:r}){const i=s.r8(r);e.sign(i),e.zero(i),e[t]=i};function C({cpu:t},e){const s=t.a+e+(t.carry()?1:0);t.zero(s),t.sign(s),t.overflow(~(t.a^e)&(t.a^s)&128),t.carry(s>255),t.a=255&s}const b=({reg:t,idx:e})=>function({cpu:s,mem:r,operand:i}){let n=r.r16(i);const a=n>>8,o=255&n;n=o+s[e]>255?((a&s[t])<<8)+o+s[e]:(a<<8)+o+s[e];const c=s[t]&a+1;r.w8({val:c,addr:n})},x=({from:t,to:e})=>function({cpu:s}){const r=s[t];s.sign(r),s.zero(r),s[e]=r},O=(...t)=>function({...e}){t.forEach((t=>t(e)))};function L({opcode:t,cpu:e}){throw new Error(`Invalid opcode: ${t.to(16)} at ${e.pc.to(16,2)}`)}const P=({cpu:t,mem:e,addr:s})=>C({cpu:t},e.r8(s));function S({cpu:t,mem:e,addr:s}){const r=e.r8(s)&t.a;t.sign(r),t.zero(r),t.a=r}function k({opcode:t,cpu:e,mem:s,addr:r}){const i=t=>(e.carry(128&t),t=t<<1&255,e.sign(t),e.zero(t),t);if(10===t)e.a=i(e.a);else{const t=i(s.r8(r));s.w8({val:t,addr:r})}}const D=g("carry",!1),T=g("carry",!0),N=g("zero",!0);function B({cpu:t,mem:e,addr:s}){const r=e.r8(s);t.sign(r),t.overflow(64&r),t.zero(r&t.a)}const E=g("sign",!0),I=g("zero",!1),X=g("sign",!1);const z=g("overflow",!1),F=g("overflow",!0);const M=R("a"),j=R("x"),Y=R("y");function U({cpu:t,mem:e,addr:s}){const r=e.r8(s)-1;t.sign(r),t.zero(r),e.w8({val:r,addr:s})}const K=y("x"),q=y("y");function H({cpu:t,mem:e,addr:s}){const r=e.r8(s)^t.a;t.sign(r),t.zero(r),t.a=r}function V({cpu:t,mem:e,addr:s}){const r=e.r8(s)+1;t.sign(r),t.zero(r),e.w8({val:r,addr:s})}const W=A("x"),J=A("y");function $({cpu:t,addr:e}){t.pc=e}const Q=v("a"),_=v("x"),G=v("y");function Z({opcode:t,cpu:e,mem:s,addr:r}){const i=t=>(e.carry(1&t),t>>=1,e.sign(t),e.zero(t),t);if(74===t)e.a=i(e.a);else{const t=i(s.r8(r));s.w8({val:t,addr:r})}}function tt(){}function et({cpu:t,mem:e,addr:s}){const r=e.r8(s)|t.a;t.sign(r),t.zero(r),t.a=r}function st({opcode:t,cpu:e,mem:s,addr:r}){const i=t=>(t<<=1,e.carry()&&(t|=1),e.carry(t>255),t&=255,e.sign(t),e.zero(t),t);if(42===t)e.a=i(e.a);else{const t=i(s.r8(r));s.w8({val:t,addr:r})}}function rt({opcode:t,cpu:e,mem:s,addr:r}){const i=t=>(e.carry()&&(t|=256),e.carry(1&t),t>>=1,e.sign(t),e.zero(t),t);if(106===t)e.a=i(e.a);else{const t=i(s.r8(r));s.w8({val:t,addr:r})}}function it({cpu:t,mem:e,addr:s}){C({cpu:t},255^e.r8(s))}function nt({cpu:t,mem:e,addr:s}){e.w8({val:t.a,addr:s})}function at({cpu:t,mem:e,addr:s}){e.w8({val:t.x,addr:s})}function ot({cpu:t,mem:e,addr:s}){e.w8({val:t.y,addr:s})}const ct=x({from:"a",to:"x"}),ht=x({from:"a",to:"y"}),lt=x({from:"sp",to:"x"}),ut=x({from:"x",to:"a"});const mt=x({from:"y",to:"a"});function pt({cpu:t,...e}){S({...e,cpu:t}),t.carry(t.sign())}function dt({cpu:t,mem:e,addr:s}){e.w8({val:t.a&t.x,addr:s})}function ft({cpu:t,mem:e,addr:s}){e.w8({val:t.x&t.a&7,addr:s})}const wt=O(U,M),gt=O(V,it),Rt=L;const yt=O(Q,ct),At=O(st,S),vt=O(rt,P),Ct=O(k,et),bt=O(Z,H),xt=b({reg:"x",idx:"y"});const Ot=[function({cpu:t}){t.brk=!0},et,Rt,Ct,tt,et,k,Ct,function({cpu:t}){t.push8(48|t.stat)},et,k,pt,tt,et,k,Ct,X,et,Rt,Ct,tt,et,k,Ct,function({cpu:t}){t.carry(!1)},et,tt,Ct,tt,et,k,Ct,function({cpu:t,addr:e}){t.push16(t.pc-1),t.pc=e},S,Rt,At,B,S,st,At,function({cpu:t}){t.stat=207&t.pull8()},S,st,pt,B,S,st,At,E,S,Rt,At,tt,S,st,At,function({cpu:t}){t.carry(!0)},S,tt,At,tt,S,st,At,function({cpu:t}){t.stat=207&t.pull8(),t.pc=t.pull16()},H,Rt,bt,tt,H,Z,bt,function({cpu:t}){t.push8(t.a)},H,Z,function({...t}){S(t),Z({...t,opcode:74})},$,H,Z,bt,z,H,Rt,bt,tt,H,Z,bt,function({cpu:t}){t.interrupt(!1)},H,tt,bt,tt,H,Z,bt,function({cpu:t}){t.pc=t.pull16()+1&65535},P,Rt,vt,tt,P,rt,vt,function({cpu:t}){const e=t.pull8();t.sign(e),t.zero(e),t.a=e},P,rt,function({cpu:t,mem:e,addr:s}){let r=t.a&e.r8(s);t.carry()&&(r|=256),t.overflow(r>>7&1^r>>6&1),t.carry(128&r),r>>=1,t.zero(r),t.sign(r),t.a=r},$,P,rt,vt,F,P,Rt,vt,tt,P,rt,vt,function({cpu:t}){t.interrupt(!0)},P,tt,vt,tt,P,rt,vt,tt,nt,tt,dt,ot,nt,at,dt,q,tt,ut,L,ot,nt,at,dt,D,nt,Rt,ft,ot,nt,at,dt,mt,nt,function({cpu:t}){t.sp=t.x},function({cpu:t,mem:e,addr:s}){t.sp=t.x&t.a;let r=1+(e.r8(s)>>4);r&=t.sp,e.w8({val:r,addr:s})},b({reg:"y",idx:"x"}),nt,xt,ft,G,Q,_,yt,G,Q,_,yt,ht,Q,ct,yt,G,Q,_,yt,T,Q,Rt,yt,G,Q,_,yt,function({cpu:t}){t.overflow(!1)},Q,lt,function({cpu:t,mem:e,addr:s}){const r=t.sp&e.r8(s);t.sign(r),t.zero(r),t.a=t.x=t.sp=r},G,Q,_,yt,Y,M,tt,wt,Y,M,U,wt,J,M,K,function({cpu:t,mem:e,addr:s}){const r=t.x&t.a;let i=e.r8(s);t.carry(r>=i),i=r-i,t.sign(i),t.zero(i),t.x=255&i},Y,M,U,wt,I,M,Rt,wt,tt,M,U,wt,function({cpu:t}){t.decimal(!1)},M,tt,wt,tt,M,U,wt,j,it,tt,gt,j,it,V,gt,W,it,tt,it,j,it,V,gt,N,it,Rt,gt,tt,it,V,gt,function({cpu:t}){t.decimal(!0)},it,tt,gt,tt,it,V,gt],Lt=[6,7,6,7,11,11,11,11,6,5,4,5,1,1,1,1,10,9,6,9,12,12,12,12,6,3,6,3,2,2,2,2,1,7,6,7,11,11,11,11,6,5,4,5,1,1,1,1,10,9,6,9,12,12,12,12,6,3,6,3,2,2,2,2,6,7,6,7,11,11,11,11,6,5,4,5,1,1,1,1,10,9,6,9,12,12,12,12,6,3,6,3,2,2,2,2,6,7,6,7,11,11,11,11,6,5,4,5,8,1,1,1,10,9,6,9,12,12,12,12,6,3,6,3,2,2,2,2,5,7,5,7,11,11,11,11,6,5,6,5,1,1,1,1,10,9,6,9,12,12,13,13,6,3,6,3,2,2,3,3,5,7,5,7,11,11,11,11,6,5,6,5,1,1,1,1,10,9,6,9,12,12,13,13,6,3,6,3,2,2,3,3,5,7,5,7,11,11,11,11,6,5,6,5,1,1,1,1,10,9,6,9,12,12,12,12,6,3,6,3,2,2,2,2,5,7,5,7,11,11,11,11,6,5,6,5,1,1,1,1,10,9,6,9,12,12,12,12,6,3,6,3,2,2,2,2],Pt=[2,2,1,2,2,2,2,2,1,2,1,2,3,3,3,3,2,2,1,2,2,2,2,2,1,3,1,3,3,3,3,3,3,2,1,2,2,2,2,2,1,2,1,2,3,3,3,3,2,2,1,2,2,2,2,2,1,3,1,3,3,3,3,3,1,2,1,2,2,2,2,2,1,2,1,2,3,3,3,3,2,2,1,2,2,2,2,2,1,3,1,3,3,3,3,3,1,2,1,2,2,2,2,2,1,2,1,2,3,3,3,3,2,2,1,2,2,2,2,2,1,3,1,3,3,3,3,3,2,2,2,2,2,2,2,2,1,2,1,2,3,3,3,3,2,2,1,2,2,2,2,2,1,3,1,3,3,3,3,3,2,2,2,2,2,2,2,2,1,2,1,2,3,3,3,3,2,2,1,2,2,2,2,2,1,3,1,3,3,3,3,3,2,2,2,2,2,2,2,2,1,2,1,2,3,3,3,3,2,2,1,2,2,2,2,2,1,3,1,3,3,3,3,3,2,2,2,2,2,2,2,2,1,2,1,2,3,3,3,3,2,2,1,2,2,2,2,2,1,3,1,3,3,3,3,3],St=[7,6,2,8,3,3,5,5,3,2,2,2,4,4,6,6,2,5,2,8,4,4,6,6,2,4,2,7,4,4,7,7,6,6,2,8,3,3,5,5,4,2,2,2,4,4,6,6,2,5,2,8,4,4,6,6,2,4,2,7,4,4,7,7,6,6,2,8,3,3,5,5,3,2,2,2,3,4,6,6,2,5,2,8,4,4,6,6,2,4,2,7,4,4,7,7,6,6,2,8,3,3,5,5,4,2,2,2,5,4,6,6,2,5,2,8,4,4,6,6,2,4,2,7,4,4,7,7,2,6,2,6,3,3,3,3,2,2,2,2,4,4,4,4,2,6,2,6,4,4,4,4,2,5,2,5,5,5,5,5,2,6,2,6,3,3,3,3,2,2,2,2,4,4,4,4,2,5,2,5,4,4,4,4,2,4,2,4,4,4,4,4,2,6,2,8,3,3,5,5,2,2,2,2,4,4,6,6,2,5,2,8,4,4,6,6,2,4,2,7,4,4,7,7,2,6,2,8,3,3,5,5,2,2,2,2,4,4,6,6,2,5,2,8,4,4,6,6,2,4,2,7,4,4,7,7],kt=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,1,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,1,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,1,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,1,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,1,0,0,0,0,0,1,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,1,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,1,0,0,1,1,0,0],Dt=["BRK","ORA","KIL","SLO","NOP","ORA","ASL","SLO","PHP","ORA","ASL","ANC","NOP","ORA","ASL","SLO","BPL","ORA","KIL","SLO","NOP","ORA","ASL","SLO","CLC","ORA","NOP","SLO","NOP","ORA","ASL","SLO","JSR","AND","KIL","RLA","BIT","AND","ROL","RLA","PLP","AND","ROL","ANC","BIT","AND","ROL","RLA","BMI","AND","KIL","RLA","NOP","AND","ROL","RLA","SEC","AND","NOP","RLA","NOP","AND","ROL","RLA","RTI","EOR","KIL","SRE","NOP","EOR","LSR","SRE","PHA","EOR","LSR","ALR","JMP","EOR","LSR","SRE","BVC","EOR","KIL","SRE","NOP","EOR","LSR","SRE","CLI","EOR","NOP","SRE","NOP","EOR","LSR","SRE","RTS","ADC","KIL","RRA","NOP","ADC","ROR","RRA","PLA","ADC","ROR","ARR","JMP","ADC","ROR","RRA","BVS","ADC","KIL","RRA","NOP","ADC","ROR","RRA","SEI","ADC","NOP","RRA","NOP","ADC","ROR","RRA","NOP","STA","NOP","SAX","STY","STA","STX","SAX","DEY","NOP","TXA","XAA","STY","STA","STX","SAX","BCC","STA","KIL","AHX","STY","STA","STX","SAX","TYA","STA","TXS","TAS","SHY","STA","SHX","AHX","LDY","LDA","LDX","LAX","LDY","LDA","LDX","LAX","TAY","LDA","TAX","LAX","LDY","LDA","LDX","LAX","BCS","LDA","KIL","LAX","LDY","LDA","LDX","LAX","CLV","LDA","TSX","LAS","LDY","LDA","LDX","LAX","CPY","CMP","NOP","DCP","CPY","CMP","DEC","DCP","INY","CMP","DEX","AXS","CPY","CMP","DEC","DCP","BNE","CMP","KIL","DCP","NOP","CMP","DEC","DCP","CLD","CMP","NOP","DCP","NOP","CMP","DEC","DCP","CPX","SBC","NOP","ISC","CPX","SBC","INC","ISC","INX","SBC","NOP","SBC","CPX","SBC","INC","ISC","BEQ","SBC","KIL","ISC","NOP","SBC","INC","ISC","SED","SBC","NOP","ISC","NOP","SBC","INC","ISC"],Tt=new Array(256).fill(null).map(((t,e)=>({opcode:e,execute:Ot[e],mode:Lt[e],bytes:Pt[e],cycles:St[e],branchCycles:kt[e],mnemonic:Dt[e]}))),Nt=8192,Bt=8193,Et=8197,It=16404;function Xt(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const zt=()=>{},Ft=()=>{};class Mt{constructor(t){Xt(this,"nes",null),Xt(this,"ram",new Uint8Array(2048)),Xt(this,"apu",new Uint8Array(24)),this.nes=t,Object.seal(this)}r8(t){switch(zt("read at: %s",(t&=65535).to(16,2)),t>>12){case 0:case 1:return this.ram[2047&t];case 2:case 3:return this.nes.ppu.r8(t);default:if(t==It)this.nes.ppu.r8(t);else{if(16406==t)return this.nes.controller.read();if(t<16408)return this.apu[31&t];if(t<16416)return 0}return this.nes.cart.r8(t)}throw new o(t)}w8({val:t,addr:e}){switch(zt("write at: %s, val: %s",(e&=65535).to(16,2),t.to(16)),e>>12){case 0:case 1:return void(this.ram[2047&e]=t);case 2:case 3:return void this.nes.ppu.w8({val:t,addr:e});default:if(e==It)return void this.nes.ppu.w8({val:t,addr:e});if(16406==e)return void this.nes.controller.write(t);if(e<16408)return void(this.apu[31&e]=t);if(e<16416)return;return e<24580&&Ft("%s: %s",e.to(16),t.to(16)),void this.nes.cart.w8({val:t,addr:e})}throw new o(e)}r16(t){return this.r8(t)|this.r8(++t)<<8}}function jt(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const Yt=()=>{},Ut=()=>{},Kt=()=>{};class qt{constructor(t){jt(this,"mem",null),jt(this,"a",0),jt(this,"x",0),jt(this,"y",0),jt(this,"stat",0),jt(this,"pc",0),jt(this,"sp",0),jt(this,"cycles",0),jt(this,"haltCycles",0),jt(this,"irq",!1),jt(this,"nmi",!1),jt(this,"brk",!1),this.mem=t,Object.seal(this)}push8(t){t&=255;const e=256|this.sp;Kt("push to: %s, val: %s",e.to(16,2),t.to(16)),this.mem.w8({val:t,addr:e}),this.sp=255&--this.sp}push16(t){this.push8(t>>8),this.push8(t)}pull8(){this.sp=255&++this.sp;const t=256|this.sp,e=this.mem.r8(t);return Kt("pull from: %s, val: %s",t.to(16,2),e.to(16)),e}pull16(){return this.pull8()|this.pull8()<<8}carry(t){return void 0!==t&&(t?this.stat|=1:this.stat&=-2),!!(1&this.stat)}zero(t){return void 0!==t&&(0==(255&t)?this.stat|=2:this.stat&=-3),!!(2&this.stat)}interrupt(t){return void 0!==t&&(t?this.stat|=4:this.stat&=-5),!!(4&this.stat)}decimal(t){return void 0!==t&&(t?this.stat|=8:this.stat&=-9),!!(8&this.stat)}overflow(t){return void 0!==t&&(t?this.stat|=64:this.stat&=-65),!!(64&this.stat)}sign(t){return void 0!==t&&((128&t)>0?this.stat|=128:this.stat&=-129),!!(128&this.stat)}reset(){const t=this.mem.r16(65532);Yt("reset addr: %s",t.to(16,2)),this.pc=t,this.sp=511}step(){return this.cycles=0,this.handleInterrupts(),0==this.haltCycles?(this.runCycle(),this.cycles):(this.haltCycles--,1)}handleInterrupts(){let t,e=this.stat;if(this.nmi)t=65530,e=-17&(32|e),this.nmi=!1;else if(this.irq&&!this.interrupt())t=65534,e=-17&(32|e),this.irq=!1,this.interrupt(!0);else{if(!this.brk)return;t=65534,e|=48,this.brk=!1,this.interrupt(!0)}this.push16(this.pc),this.push8(e),this.pc=this.mem.r16(t),this.cycles+=7,Ut("pc: %s",this.pc.to(16))}decode(){const t=this.mem.r8(this.pc),{mnemonic:e,...s}=Tt[t];return Yt("pc: %s, op: %s[%s]",this.pc.to(16,2),t.to(16),e),s}pageCrossedCycles({branchCycles:t,addr:e}){return(65280&this.pc)!=(65280&e)?t:0}runCycle(){const t=this.decode(),{mode:e,bytes:s,cycles:r,branchCycles:i,execute:n}=t,a=this.pc+1;let o,c=r;switch(e){case 4:case 6:break;case 10:case 5:o=a;break;case 1:o=this.mem.r16(a);break;case 2:o=this.mem.r16(a)+this.x,c+=this.pageCrossedCycles({branchCycles:i,addr:o});break;case 3:o=this.mem.r16(a)+this.y,c+=this.pageCrossedCycles({branchCycles:i,addr:o});break;case 8:{const t=this.mem.r16(a),e=65280&t|t+1&255;o=this.mem.r8(t)|this.mem.r8(e)<<8;break}case 7:{const t=this.mem.r8(a)+this.x&255,e=t+1&255;o=this.mem.r8(t)|this.mem.r8(e)<<8;break}case 9:{const t=this.mem.r8(a),e=t+1&255;o=(this.mem.r8(t)|this.mem.r8(e)<<8)+this.y,c+=this.pageCrossedCycles({branchCycles:i,addr:o});break}case 11:o=this.mem.r8(a);break;case 12:o=this.mem.r8(a)+this.x&255;break;case 13:o=this.mem.r8(a)+this.y&255;break;default:throw new Error("Unknown addressing mode")}this.pc=this.pc+s&65535,this.cycles+=c,n({...t,cpu:this,mem:this.mem,addr:o,operand:a})}}function Ht(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class Vt{constructor(t){Ht(this,"nes",null),Ht(this,"vram",[new Uint8Array(1024),new Uint8Array(1024)]),Ht(this,"palette",new Uint8Array(32)),this.nes=t,Object.seal(this)}getNametable(t){return this.nes.cart.mirroring?t>>10&1:t>>11&1}r8(t){switch(t>>12){case 0:case 1:return this.nes.cart.r8(t);case 2:case 3:return t<16128?this.vram[this.getNametable(t)][1023&t]:this.palette[31&t]}throw new o(t)}w8({val:t,addr:e}){switch(e>>12){case 0:case 1:{const s=e>>12&1;return this.nes.video.updatePattern({table:s,val:t,addr:e}),void this.nes.cart.w8({val:t,addr:e})}case 2:case 3:if(e<16128){const s=this.getNametable(e);if((1023&e)<960){this.nes.video.nametable[s][e>>5&31][31&e]=t}else{const r=this.nes.video.attribute[s][e>>3&7][7&e];for(let e=0;e<r.length;e++)r[e]=t>>(e<<1)&3}this.vram[s][1023&e]=t}else{const s=(3&e)-1;16128==e?this.nes.video.bkgPalette=t:s>-1&&(this.nes.video.palette[e>>2&7][s]=t),this.palette[31&e]=t}return}throw new o(e)}}function Wt(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const Jt=()=>{};class $t{constructor(t){Wt(this,"nes",null),Wt(this,"mem",null),Wt(this,"oam",new Uint8Array(256)),Wt(this,"ctrl",0),Wt(this,"mask",0),Wt(this,"stat",0),Wt(this,"scroll",[0,0]),Wt(this,"scanline",241),Wt(this,"cycles",0),Wt(this,"resetCycles",0),Wt(this,"resetIgnoreWrites",!0),Wt(this,"writeCount",0),Wt(this,"latch",0),Wt(this,"oamAddr",0),Wt(this,"vramAddr",0),Wt(this,"renderFrame",!1),Wt(this,"isOddFrame",!0),this.nes=t,this.mem=new Vt(t),Object.seal(this)}reset(){this.ctrl=0,this.mask=0,this.stat&=128,this.scroll=[0,0],this.cycles=0,this.scanline=0,this.resetCycles=0,this.resetIgnoreWrites=!0,this.writeCount=0,this.latch=0,this.vramAddr=0,this.renderFrame=!1,this.isOddFrame=!1}incrementVramAddress(){this.vramAddr+=0==(4&this.ctrl)?1:32,this.vramAddr&=16383}step(){this.resetIgnoreWrites&&(this.resetCycles++,this.resetCycles>29780&&(this.resetCycles=0,this.resetIgnoreWrites=!1)),1==this.cycles?241==this.scanline?(this.nes.cpu.nmi=(128&this.ctrl)>0,this.stat|=128):261==this.scanline&&(this.stat&=-225):339==this.cycles&&261==this.scanline&&this.isOddFrame&&24&this.mask&&this.cycles++,340==this.cycles&&(this.renderScanline(),this.isOddFrame=!this.isOddFrame,this.cycles=-1),this.cycles++}renderScanline(){this.scanline<240?this.nes.video.drawLine():261==this.scanline&&(this.renderFrame=!0,this.scanline=-1),this.scanline++}r8(t){switch(Jt("read at: %s",t.to(16,2)),8192|7&t){case 8194:{const t=this.stat;this.stat&=-129,this.writeCount=0,this.latch=224&t|31&this.latch;break}case 8196:this.latch=this.oam[this.oamAddr];break;case 8199:this.latch=this.mem.r8({addr:this.vramAddr}),this.incrementVramAddress()}return this.latch}w8({val:t,addr:e}){const s=61447&e;if(this.resetIgnoreWrites&&8197&s)Jt("write at: %s ignored",s.to(16,2));else{if(t&=255,Jt("write at: %s, val: %s",e.to(16,2),t.to(16)),this.latch=t,e!=It){switch(s){case Nt:return void(this.ctrl=t);case Bt:return void(this.mask=t);case 8195:return void(this.oamAddr=t);case 8196:{const e=this.oamAddr++;return this.nes.video.sprites[e>>2][3&e]=this.oam[e]=t,void(this.oamAddr&=255)}case Et:return this.scroll[this.writeCount++]=t,void(this.writeCount&=1);case 8198:return 0===this.writeCount?this.vramAddr=t<<8:this.vramAddr|=t,this.vramAddr&=16383,this.writeCount++,void(this.writeCount&=1);case 8199:return this.mem.w8({val:t,addr:this.vramAddr}),void this.incrementVramAddress()}throw new o(e)}for(let e=0;e<256;e++){const s=this.nes.cpu.mem.r8(t<<8|e);this.nes.video.sprites[e>>2][3&e]=this.oam[e]=s}this.nes.cpu.haltCycles+=513}}}const Qt=[[124,124,124],[0,0,252],[0,0,188],[68,40,188],[148,0,132],[168,0,32],[168,16,0],[136,20,0],[80,48,0],[0,120,0],[0,104,0],[0,88,0],[0,64,88],[0,0,0],[0,0,0],[0,0,0],[188,188,188],[0,120,248],[0,88,248],[104,68,252],[216,0,204],[228,0,88],[248,56,0],[228,92,16],[172,124,0],[0,184,0],[0,168,0],[0,168,68],[0,136,136],[0,0,0],[0,0,0],[0,0,0],[248,248,248],[60,188,252],[104,136,252],[152,120,248],[248,120,248],[248,88,152],[248,120,88],[252,160,68],[248,184,0],[184,248,24],[88,216,84],[88,248,152],[0,232,216],[120,120,120],[0,0,0],[0,0,0],[252,252,252],[164,228,252],[184,184,248],[216,184,248],[248,184,248],[248,164,192],[240,208,176],[252,224,168],[248,216,120],[216,248,120],[184,248,184],[184,248,216],[0,252,252],[248,216,248],[0,0,0],[0,0,0]];function _t(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const Gt=()=>{},Zt=256,te=240;class ee{constructor(t,e,s){_t(this,"nes",null),_t(this,"showFps",!1),_t(this,"onFrame",(()=>{})),_t(this,"fps",0),_t(this,"bkgPalette",0),_t(this,"linePtrn",new Array(Zt).fill(0)),_t(this,"lineColor",new Array(Zt)),_t(this,"canvas",function(t,e){const s=document.createElement("canvas");return s.width=t,s.height=e,s}(Zt,te)),_t(this,"ctx",this.canvas.getContext("2d",{alpha:!1,pixelFormat:"RGB24"})),_t(this,"image",this.ctx.getImageData(0,0,Zt,te)),_t(this,"data",this.image.data),_t(this,"nametable",new Array(2).fill().map((()=>new Array(30).fill().map((()=>new Uint8Array(32)))))),_t(this,"attribute",new Array(2).fill().map((()=>new Array(8).fill().map((()=>new Array(8).fill().map((()=>new Array(4).fill(0)))))))),_t(this,"pattern",new Array(2).fill().map((()=>new Array(256).fill().map((()=>new Array(8).fill().map((()=>new Uint8Array(8)))))))),_t(this,"palette",new Array(8).fill().map((()=>new Array(3).fill(0)))),_t(this,"sprites",new Array(64).fill().map((()=>new Uint8Array(4)))),this.nes=t,this.showFps=e,this.onFrame=s,this.ctx.patternQuality="fast",this.ctx.quality="fast",this.ctx.textDrawingMode="path",this.ctx.antialias="none",this.ctx.font="10px Lucida Console",this.ctx.textAlign="end",this.ctx.textBaseline="top",this.ctx.fillStyle="#00ff00",Object.seal(this)}updatePattern({table:t,val:e,addr:s}){const r=this.pattern[t][s>>4&255][7&s],i=s>>3&1;for(let t=0;t<r.length;t++){const s=7-t;i||(r[s]=0),r[s]|=(e>>t&1)<<i}}drawBackground(){const{ppu:t,cart:e}=this.nes,[s,r]=t.scroll,i=r+t.scanline,n=7&i,a=(i>>3)%30;let o=(3&t.ctrl)>>1;!e.mirroring&&i>=te&&(o=1&++o);const c=this.nametable[o],h=this.attribute[o],l=this.pattern[(16&t.ctrl)>>4];for(let e=(2&t.mask)<<2^8;e<Zt;e++){const t=s+e,r=t>>3&31,i=c[a][r],o=this.linePtrn[e]=l[i][n][7&t];if(!o)continue;const u=h[a>>2][r>>2],m=this.palette[u[2&a|r>>1&1]][o-1];this.lineColor[e]=m}}drawSprites(){const{ppu:t}=this.nes,e=this.pattern[(8&t.ctrl)>>3];let s=[];for(let e=0;e<this.sprites.length;e++)t.scanline>this.sprites[e][0]&&t.scanline<=this.sprites[e][0]+8&&this.sprites[e][0]<239&&s.push(e);s.length>8&&(t.stat|=32);const r=(t.mask>>1&3^3)>0;for(let i=Math.min(8,s.length)-1;i>-1;i--){const n=this.sprites[s[i]],a=n[2]>>5&1,o=n[2]>>6&1,c=n[2]>>7,h=n[3],l=t.scanline-n[0]-1,u=c?7-l:l;for(let c=h;c<h+8&&c<Zt;c++){const l=o?7-(c-h):c-h,m=e[n[1]][u][l];if(!m)continue;const p=this.palette[4|3&n[2]][m-1];!s[i]&&p&&this.linePtrn[c]&&(c>7&&c<255||c<7&&!r)&&(t.stat|=64),a&&this.linePtrn[c]||(this.lineColor[c]=p)}}}drawLine(){const{ppu:t}=this.nes;Gt("drawing scanline: %d",t.scanline),this.linePtrn.fill(0),this.lineColor.fill(this.bkgPalette),8&t.mask&&this.drawBackground(),16&t.mask&&this.drawSprites();let e=t.scanline*Zt*4;for(let t=0;t<Zt;t++)this.data[e++]=Qt[this.lineColor[t]][0],this.data[e++]=Qt[this.lineColor[t]][1],this.data[e++]=Qt[this.lineColor[t]][2],this.data[e++]=255}render(){this.ctx.clearRect(0,0,Zt,te),this.ctx.putImageData(this.image,0,0),this.showFps&&(this.nes.frameCount%15||(this.fps=Math.floor(this.nes.fps)),this.ctx.fillText(this.fps,251,5)),this.onFrame(this.canvas)}}function se(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const re={40:5,13:3,38:4,16:2,37:6,90:1,39:7,88:0};class ie{constructor(){se(this,"state",new Array(8).fill(64)),se(this,"strobe",0),se(this,"bit",0),Object.seal(this)}write(t){this.strobe||(this.bit=0),this.strobe=1&t}read(){return this.bit>8?65:this.state[this.bit++]}keyDown(t){null!=re[t]&&(this.state[re[t]]=65)}keyUp(t){null!=re[t]&&(this.state[re[t]]=64)}}function ne(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const ae=()=>{};class oe{constructor({showFps:t,onFrame:e}){ne(this,"video",null),ne(this,"cart",new w(this)),ne(this,"ppu",new $t(this)),ne(this,"cpu",new qt(new Mt(this))),ne(this,"controller",new ie),ne(this,"loop",null),ne(this,"frameCycles",0),ne(this,"frameCount",0),ne(this,"fps",0),this.video=new ee(this,t,e),Object.seal(this)}loadCart(t){ae("loading cart"),this.cart.load(new Uint8Array(t))}runFrame(){let t;t:for(;;)for(t=this.cpu.step(),this.frameCycles+=t,t*=3;t>0;t--)if(this.ppu.step(),this.ppu.renderFrame)break t;this.ppu.renderFrame=!1,this.video.render(),ae("frame: %d, cycles: %d, pc: %s",this.frameCount,this.frameCycles,this.cpu.pc.to(16)),this.frameCount=++this.frameCount%60,this.frameCycles=0}start(){ae("start"),this.cpu.reset(),this.ppu.reset();let t=i()();const e=()=>{const s=i()();this.fps=1e3/(s-t),t=s,this.runFrame(),this.loop=a()(e)};this.loop=a()(e)}}},593:()=>{"use strict";Number.prototype.to=function(){}},75:function(t,e,s){var r=s(155);(function(){var e,s,i,n,a,o;"undefined"!=typeof performance&&null!==performance&&performance.now?t.exports=function(){return performance.now()}:null!=r&&r.hrtime?(t.exports=function(){return(e()-a)/1e6},s=r.hrtime,n=(e=function(){var t;return 1e9*(t=s())[0]+t[1]})(),o=1e9*r.uptime(),a=n-o):Date.now?(t.exports=function(){return Date.now()-i},i=Date.now()):(t.exports=function(){return(new Date).getTime()-i},i=(new Date).getTime())}).call(this)},155:t=>{var e,s,r=t.exports={};function i(){throw new Error("setTimeout has not been defined")}function n(){throw new Error("clearTimeout has not been defined")}function a(t){if(e===setTimeout)return setTimeout(t,0);if((e===i||!e)&&setTimeout)return e=setTimeout,setTimeout(t,0);try{return e(t,0)}catch(s){try{return e.call(null,t,0)}catch(s){return e.call(this,t,0)}}}!function(){try{e="function"==typeof setTimeout?setTimeout:i}catch(t){e=i}try{s="function"==typeof clearTimeout?clearTimeout:n}catch(t){s=n}}();var o,c=[],h=!1,l=-1;function u(){h&&o&&(h=!1,o.length?c=o.concat(c):l=-1,c.length&&m())}function m(){if(!h){var t=a(u);h=!0;for(var e=c.length;e;){for(o=c,c=[];++l<e;)o&&o[l].run();l=-1,e=c.length}o=null,h=!1,function(t){if(s===clearTimeout)return clearTimeout(t);if((s===n||!s)&&clearTimeout)return s=clearTimeout,clearTimeout(t);try{s(t)}catch(e){try{return s.call(null,t)}catch(e){return s.call(this,t)}}}(t)}}function p(t,e){this.fun=t,this.array=e}function d(){}r.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var s=1;s<arguments.length;s++)e[s-1]=arguments[s];c.push(new p(t,e)),1!==c.length||h||a(m)},p.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=d,r.addListener=d,r.once=d,r.off=d,r.removeListener=d,r.removeAllListeners=d,r.emit=d,r.prependListener=d,r.prependOnceListener=d,r.listeners=function(t){return[]},r.binding=function(t){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(t){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},87:(t,e,s)=>{for(var r=s(407),i="undefined"==typeof window?s.g:window,n=["moz","webkit"],a="AnimationFrame",o=i["request"+a],c=i["cancel"+a]||i["cancelRequest"+a],h=0;!o&&h<n.length;h++)o=i[n[h]+"Request"+a],c=i[n[h]+"Cancel"+a]||i[n[h]+"CancelRequest"+a];if(!o||!c){var l=0,u=0,m=[];o=function(t){if(0===m.length){var e=r(),s=Math.max(0,16.666666666666668-(e-l));l=s+e,setTimeout((function(){var t=m.slice(0);m.length=0;for(var e=0;e<t.length;e++)if(!t[e].cancelled)try{t[e].callback(l)}catch(t){setTimeout((function(){throw t}),0)}}),Math.round(s))}return m.push({handle:++u,callback:t,cancelled:!1}),u},c=function(t){for(var e=0;e<m.length;e++)m[e].handle===t&&(m[e].cancelled=!0)}}t.exports=function(t){return o.call(i,t)},t.exports.cancel=function(){c.apply(i,arguments)},t.exports.polyfill=function(t){t||(t=i),t.requestAnimationFrame=o,t.cancelAnimationFrame=c}},407:function(t,e,s){var r=s(155);(function(){var e,s,i,n,a,o;"undefined"!=typeof performance&&null!==performance&&performance.now?t.exports=function(){return performance.now()}:null!=r&&r.hrtime?(t.exports=function(){return(e()-a)/1e6},s=r.hrtime,n=(e=function(){var t;return 1e9*(t=s())[0]+t[1]})(),o=1e9*r.uptime(),a=n-o):Date.now?(t.exports=function(){return Date.now()-i},i=Date.now()):(t.exports=function(){return(new Date).getTime()-i},i=(new Date).getTime())}).call(this)}},e={};function s(r){if(e[r])return e[r].exports;var i=e[r]={exports:{}};return t[r].call(i.exports,i,i.exports,s),i.exports}return s.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return s.d(e,{a:e}),e},s.d=(t,e)=>{for(var r in e)s.o(e,r)&&!s.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:e[r]})},s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),s.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),s(679)})().default;